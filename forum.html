<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MIC - Fórum</title>
  <link href="https://fonts.googleapis.com/css2?family=Alice&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Alfa+Slab+One&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/forum.css">
</head>
<body>
  
    <!-- Intérprete de Libras (Script do GOV BR) -->
  <div vw class="enabled">
    <div vw-access-button class="active"></div>
    <div vw-plugin-wrapper>
      <div class="vw-plugin-top-wrapper"></div>
    </div>
  </div>
  <script src="https://vlibras.gov.br/app/vlibras-plugin.js"></script>
  <script>
    new window.VLibras.Widget('https://vlibras.gov.br/app');
  </script>
  
  <header>
    <div class="logo-container"><span class="menu-icon" onclick="toggleSidebar()">☰</span>
    <div class="logo"><h1>MIC - Music Is Connection</h1></div></div>
    <nav>
      <a href="#">Login</a>
      <a href="#">Sobre o site</a>
      <a href="#">Sobre as Criadoras</a>
      &nbsp;&nbsp;&nbsp;
      <button id="logout" type="button" class ="clear" onclick="logout()">Logout</button>
    </nav>
  </header>

  <div id="sidebar" class="sidebar">
    <span class="close-btn" onclick="toggleSidebar()">×</span>
    <a href="index.html">Página inicial</a>
    <a href="eventos.html">Eventos</a>
    <a href="aulas.html">Aulas</a>
    <a href="forum.html">Fórum</a>
    <a href="zen.html">Zen Area</a>
    <a href="noticias.html">Notícias e Estudos</a>
  </div>

  <section>
    <h3 class="section-title">Fórum de Discussão</h3>
    <div class="card">
      <h4>Criar Nova Postagem</h4><br>
      <input id="post-title" class="input-field" type="text" placeholder="Título da Postagem">
      <textarea id="post-content" class="textarea-field" placeholder="Escreva sua postagem..."></textarea>
      <button onclick="createPost()" class="btn">Postar</button>
    </div>
    <div id="posts-container"></div>
  </section>
  <script>
  let posts = [];

  function loadPosts() {
    const savedPosts = localStorage.getItem('forum-posts');
    if (savedPosts) {
      posts = JSON.parse(savedPosts);
    }
    renderPosts();
  }

  function savePosts() {
    localStorage.setItem('forum-posts', JSON.stringify(posts));
  }

  function createPost() {
    const title = document.getElementById('post-title').value.trim();
    const content = document.getElementById('post-content').value.trim();
    const user = firebase.auth().currentUser;

    if (!user) {
      alert("Você precisa estar logado para postar.");
      return;
    }

    if (title && content) {
      const post = {
        id: Date.now(),
        title,
        content,
        email: user.email, // SALVA O EMAIL DO USUÁRIO
        replies: []
      };
      posts.push(post);
      document.getElementById('post-title').value = '';
      document.getElementById('post-content').value = '';
      savePosts();
      renderPosts();
    } else {
      alert('Por favor, preencha o título e o conteúdo da postagem.');
    }
  }

  function addReply(postId) {
    const replyInput = document.getElementById(`reply-input-${postId}`);
    const replyContent = replyInput.value.trim();
    const user = firebase.auth().currentUser;

    if (!user) {
      alert("Você precisa estar logado para responder.");
      return;
    }

    if (replyContent) {
      const post = posts.find(p => p.id === postId);
      post.replies.push({
        text: replyContent,
        email: user.email // SALVA O EMAIL DE QUEM RESPONDEU
      });
      replyInput.value = '';
      savePosts();
      renderPosts();
    } else {
      alert('Por favor, escreva uma resposta.');
    }
  }

  function deletePost(postId) {
    if (confirm('Tem certeza que deseja deletar esta postagem?')) {
      posts = posts.filter(p => p.id !== postId);
      savePosts();
      renderPosts();
    }
  }
  function deleteReply(postId, replyIndex) {
  const user = firebase.auth().currentUser;

  if (!user) return;

  const post = posts.find(p => p.id === postId);

  if (post.replies[replyIndex].email !== user.email) {
    alert("Você só pode deletar suas próprias respostas.");
    return;
  }

  post.replies.splice(replyIndex, 1);
  savePosts();
  renderPosts();
}
  
  function renderPosts() {
  const container = document.getElementById('posts-container');
  container.innerHTML = '';

  const user = firebase.auth().currentUser;

  posts.forEach(post => {
    const isOwner = user && user.email === post.email;

    const postElement = document.createElement('div');
    postElement.className = 'card';
    postElement.innerHTML = `
      <div class="post-header">
        <h3 class="post-title">${post.title}</h3>

        <div>
          ${isOwner ? `
            <button onclick="editPost(${post.id})" class="btn" style="background:#444; font-size:0.9rem; margin-right:5px;">Editar</button>
            <button onclick="deletePost(${post.id})" class="btn" style="background:#555; font-size:0.9rem;">Deletar</button>
          ` : ``}
        </div>
      </div>

      <p class="post-content">${post.content}</p>
      <p class="post-user">— Postado por: <strong>${post.email}</strong></p>

      <div class="replies">
        <h4>Respostas:</h4>
        ${post.replies.map((reply, index) => {
          const isReplyOwner = user && user.email === reply.email;
          return `
            <p class="reply">
              ${reply.text}<br>
              <span class="reply-user">— Respondido por: <strong>${reply.email}</strong></span>

              ${isReplyOwner ? `
                <button onclick="editReply(${post.id}, ${index})" class="btn" style="background:#333; padding:4px 10px; font-size:0.75rem; margin-top:4px;">Editar Resposta</button>
                <button onclick="deleteReply(${post.id}, ${index})" class="btn" style="background:#444; padding:4px 10px; font-size:0.75rem; margin-top:4px;">Deletar Resposta</button>
              ` : ``}
            </p>
          `;
        }).join('')}

        <div style="margin-top: 15px;">
          <input id="reply-input-${post.id}" class="input-field" type="text" placeholder="Escreva uma resposta...">
          <button onclick="addReply(${post.id})" class="btn">Responder</button>
        </div>
      </div>
    `;
    container.appendChild(postElement);
  });
}

  function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('open');
  }

  function editPost(postId) {
  const user = firebase.auth().currentUser;
  if (!user) return;

  const post = posts.find(p => p.id === postId);

  if (post.email !== user.email) {
    alert("Você só pode editar suas próprias postagens.");
    return;
  }

  const newTitle = prompt("Edite o título da postagem:", post.title);
  const newContent = prompt("Edite o conteúdo da postagem:", post.content);

  if (newTitle && newContent) {
    post.title = newTitle.trim();
    post.content = newContent.trim();
    savePosts();
    renderPosts();
  }
}

function editReply(postId, replyIndex) {
  const user = firebase.auth().currentUser;
  if (!user) return;

  const post = posts.find(p => p.id === postId);
  const reply = post.replies[replyIndex];

  if (reply.email !== user.email) {
    alert("Você só pode editar suas próprias respostas.");
    return;
  }

  const newText = prompt("Edite sua resposta:", reply.text);

  if (newText) {
    reply.text = newText.trim();
    savePosts();
    renderPosts();
  }
}

  window.onload = loadPosts;
</script>

</body>
<script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-app-compat.js"> </script>
      <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-auth-compat.js"> </script>  
      <script>
      const firebaseConfig = {
      apiKey: "AIzaSyB56rpw--TZSsGvepsMmTChfketb-g0XbA",
      authDomain: "bancodedados-b2c24.firebaseapp.com",
      projectId: "bancodedados-b2c24",
      storageBucket: "bancodedados-b2c24.firebasestorage.app",
      messagingSenderId: "880842806241",
      appId: "1:880842806241:web:0e8873834a95cf94acb8a0",
      measurementId: "G-9DSXXY8HEM"
      };

      firebase.initializeApp(firebaseConfig);
    </script>
    <script src="js/js.js"></script> 
    <script src="js/auth.guard.js"></script>
    <script src="js/index.js"></script>
</html>